FROM pattylo/airo_ros_noetic:nogpu-nopkg
ENV DEBIAN_FRONTEND=noninteractive
ARG HOME=/root

# E2ES
WORKDIR $HOME
RUN sudo apt-get -y install ros-noetic-mavros \
    ros-noetic-mavros-extras \
    ros-noetic-mavros-msgs \
    libncurses5-dev \
    python3-pip \
    libgstreamer1.0-dev \
    python-jinja2 \
    python3-pip \
    python3-testresources \
    libignition-math4 \
    libgazebo11-dev 

RUN pip3 install --user empy toml numpy packaging jinja2
RUN pip3 install numpy toml empy packaging
RUN wget https://raw.githubusercontent.com/mavlink/mavros/master/mavros/scripts/install_geographiclib_datasets.sh
RUN sudo bash ./install_geographiclib_datasets.sh

RUN mkdir -p catkin_ws/src && cd ~/catkin_ws/src && \
    git clone https://github.com/HKPolyU-UAV/E2ES.git && \
    cd ~/catkin_ws/src/E2ES/3rdPartLib && \
    sudo ./install3rdPartLib.sh
RUN /bin/bash -c '. /opt/ros/noetic/setup.bash; cd ~/catkin_ws/;\
    catkin_make'


# FLVIS
WORKDIR $HOME
RUN apt update
RUN sudo apt-get install libsuitesparse-dev -y
RUN mkdir -p vio_ws/src && cd ~/vio_ws/src && \
    git clone -b noetic https://github.com/HKPolyU-UAV/FLVIS.git && \
    cd ~/vio_ws/src/FLVIS/3rdPartLib && \
    sudo ./install3rdPartLib.sh

RUN /bin/bash -c '. /opt/ros/noetic/setup.bash; cd ~/vio_ws/;\
    catkin_make'

# REALSENSE
RUN sudo mkdir -p /etc/apt/keyrings
RUN curl -sSf https://librealsense.intel.com/Debian/librealsense.pgp | sudo tee /etc/apt/keyrings/librealsense.pgp > /dev/null
RUN echo "deb [signed-by=/etc/apt/keyrings/librealsense.pgp] https://librealsense.intel.com/Debian/apt-repo `lsb_release -cs` main" | \
    sudo tee /etc/apt/sources.list.d/librealsense.list
RUN sudo apt-get update
RUN sudo apt-get install librealsense2-dkms -y
RUN sudo apt-get install librealsense2-utils -y
RUN sudo apt-get install librealsense2-dev -y
RUN sudo apt-get install librealsense2-dbg -y

RUN mkdir -p ~/camera_ws/src && cd ~/camera_ws/src/ && \
    git clone https://github.com/IntelRealSense/realsense-ros.git && \
    cd realsense-ros/ && \
    git checkout `git tag | sort -V | grep -P "^2.\d+\.\d+" | tail -1`
RUN sudo apt-get install ros-noetic-ddynamic-reconfigure -y
RUN /bin/bash -c '. /opt/ros/noetic/setup.bash; cd ~/camera_ws/src;\
    catkin_init_workspace'
RUN /bin/bash -c '. /opt/ros/noetic/setup.bash; cd ~/camera_ws;\
    catkin_make clean'
RUN /bin/bash -c '. /opt/ros/noetic/setup.bash; cd ~/camera_ws;\
    catkin_make -DCATKIN_ENABLE_TESTING=False -DCMAKE_BUILD_TYPE=Release'
RUN /bin/bash -c '. /opt/ros/noetic/setup.bash; cd ~/camera_ws;\
    catkin_make install'

RUN echo "source ~/camera_ws/devel/setup.bash" >> ~/.bashrc

# AIRo_Control_Interface

WORKDIR $HOME
RUN git clone https://github.com/acados/acados.git && \
    cd ~/acados && git checkout 568e46c && \
    git submodule update --recursive --init && \
    mkdir build && cd build && \
    cmake -DACADOS_WITH_QPOASES=ON -DACADOS_WITH_OSQP=OFF/ON -DACADOS_INSTALL_DIR=~/acados .. && \
    sudo make install -j4


RUN mkdir -p ~/airo_control_interface_ws/src && \
    cd ~/airo_control_interface_ws/src && \
    git clone https://github.com/HKPolyU-UAV/airo_control_interface.git && \
    cd ~/airo_control_interface_ws/src/airo_control_interface && \
    git checkout 1981f5f83449a9d43e5971ba669ba2158f5d9794


RUN /bin/bash -c '. /opt/ros/noetic/setup.bash; cd ~/airo_control_interface_ws/;\
    catkin_make'
RUN echo "source ~/airo_control_interface_ws/devel/setup.bash" >> ~/.bashrc

RUN sudo apt install -y software-properties-common && sudo add-apt-repository ppa:deadsnakes/ppa && sudo apt update && sudo apt install python3.7 -y
RUN python3 -m pip install pip && sudo pip3 install numpy matplotlib scipy future-fstrings casadi>=3.5.1 setuptools 
RUN sudo apt-get install python3.7-tk -y && pip install -e ~/acados/interfaces/acados_template && \
    echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:"/root/acados/lib"' >> ~/.bashrc && \
    echo 'export ACADOS_SOURCE_DIR="/root/acados"' >> ~/.bashrc
RUN sudo apt install tmuxinator -y

# AIRo_Trajectory

WORKDIR $HOME
RUN mkdir -p ~/airo_trajectory_ws/src && \
    cd ~/airo_trajectory_ws/src && git clone https://github.com/HKPolyU-UAV/airo_trajectory.git && \
    cd ~/airo_trajectory_ws
RUN /bin/bash -c '. /opt/ros/noetic/setup.bash;. ~/airo_control_interface_ws/devel/setup.bash; cd ~/airo_trajectory_ws/;\
    catkin_make'
RUN echo "source ~/airo_trajectory_ws/devel/setup.bash" >> ~/.bashrc

RUN sudo apt-get update && sudo apt-get -y install gedit